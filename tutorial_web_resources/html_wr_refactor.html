<!DOCTYPE html>
<html lang="en">
<head>
    <title>Students</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
          crossorigin="anonymous">
    <script src="/WebResources/in23gl_js_wr_student" type="text/javascript"></script>
    <link href="/WebResources/in23gl_css_wr_student" rel="stylesheet" type="text/css" />
</head>
<body>
<table id="studentsTable">
    <tr>
        <th>Student ID</th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>DOB</th>
        <th>Email</th>
        <th>University</th>
        <th>Actions</th>
    </tr>
    <!-- Rows will be added here from the JS file -->
</table>
<script>
    let universityRef;
    <!-- The `window.fetchStudents` function is responsible for populating the table with student data. -->
    window.fetchStudents = async function(students) {
        try {
            console.log("studentsHTML: ", students);
            console.log('lookupDataHTML: ', lookupData)
            // Process the result
            const table = document.getElementById('studentsTable');
            // Loop through the data and create a table row for each student
            students.entities.forEach( student => {
                const row = table.insertRow();
                //access the data from the entities and assign to corresponding cell within the table
                const idCell = row.insertCell()
                const firstNameCell = row.insertCell()
                const lastNameCell = row.insertCell()
                const dobCell = row.insertCell()
                const emailCell = row.insertCell()
                const universityCell = row.insertCell()
                const actionCell = row.insertCell();

                idCell.textContent = student.in23gl_studentid;
                firstNameCell.textContent = student.in23gl_firstname;

                lastNameCell.textContent = student.in23gl_lastname;

                const date = new Date(student.in23gl_dob);
                dobCell.textContent = date.toLocaleDateString(undefined, {timeZone: 'UTC'});
                emailCell.textContent = student.in23gl_email;
                universityCell.textContent = lookupData.universityEntity.in23gl_universityname;
                universityRef =  {
                    in23gl_universityid: lookupData.universityEntity,
                }
                console.log("universityRef: ", universityRef);

                firstNameCell.contentEditable = 'true';
                lastNameCell.contentEditable = 'true';
                dobCell.contentEditable = 'true';
                emailCell.contentEditable = 'true';

                const updateButton = createButton('Update');
                updateButton.onclick = () => updateEntity(row);

                const deleteButton = createButton('Delete');
                deleteButton.onclick = () => deleteEntity(row);

                actionCell.appendChild(updateButton);
                actionCell.appendChild(deleteButton);
            });
            const addButton = createButton('Add');
            addButton.classList.add('add-button');
            addButton.onclick = () => createRow(table, universityRef);
            table.after(addButton);
        } catch (error) {
            console.error(error);
            openErrorDialog("An error occurred while fetching the students.");
        }
    }
    // Create add button
    function createButton(textContent) {
        const button = document.createElement('button');
        button.textContent = textContent;
        return button;
    }

    async function createEntity(row) {
        try {
            // Get updated values
            const firstNameCell = row.cells[1];
            const lastNameCell = row.cells[2];
            const dobCell =  row.cells[3];
            const emailCell = row.cells[4];

            const updatedFields = {
                "in23gl_firstname": firstNameCell.textContent,
                "in23gl_lastname": lastNameCell.textContent,
                "in23gl_dob": new Date(dobCell.textContent).toLocaleDateString(undefined, {timeZone: 'UTC'}),
                "in23gl_email": emailCell.textContent,
                // Associate to the university lookup value use the navigation property see pic
                "in23gl_University@odata.bind": "/in23gl_universities(" + lookupData.universityEntity.in23gl_universityid +")"
            };
            console.log('updatedFields', updatedFields)

            const result = await xrm.WebApi.createRecord("in23gl_student", updatedFields);
            console.log("Created Student Successfully with ID " + result.id);
            const alertStrings = { confirmButtonLabel: "Ok",
                text: "Created Student Successfully with ID " + result.id,
                title: "Update Alert" };
            openAlertDialog(alertStrings);

        } catch (error) {
            openErrorDialog("An error occurred while creating the student.");
            console.log(error.message);
        }
    }

    async function updateEntity(row) {
        try {
            // Get updated values
            const firstNameCell = row.cells[1];
            const lastNameCell = row.cells[2];
            const dobCell =  row.cells[3];
            const emailCell = row.cells[4];
            const updatedFields = {
                in23gl_firstname: firstNameCell.textContent,
                in23gl_lastname: lastNameCell.textContent,
                in23gl_dob: new Date(dobCell.textContent),
                in23gl_email: emailCell.textContent
            };
            console.log('updatedFields', updatedFields)
            // Compare current and updated values
            const studentId = row.cells[0].textContent;
            await xrm.WebApi.updateRecord("in23gl_student", studentId, updatedFields);
            const alertStrings = { confirmButtonLabel: "Ok", text: "Entity updated successfully!", title: "Update Alert" };
            openAlertDialog(alertStrings);
        } catch (error) {
            console.error(error.message);
            openErrorDialog("An error occurred while updating the student.")
        }
    }

    async function deleteEntity(row) {
        try {
            const studentId = row.cells[0].textContent;
            if (studentId !== "") {
                var confirmStrings = { text:"This will delete the entity. Are you sure you want to proceed?", title:"Delete Entity" };
                var confirmOptions = { height: 200, width: 450 };
                window.parent.Xrm.Navigation.openConfirmDialog(confirmStrings, confirmOptions).then(
                    function (success) {
                        if (success.confirmed) {
                            xrm.WebApi.deleteRecord("in23gl_student", studentId);
                            deleteRow(row);
                            console.log("Deleted");
                        }
                        else
                            console.log("Dialog closed using Cancel button or X.");
                    });

            } else {

            }
        } catch (error) {
            console.error(error);
            openErrorDialog("An error occurred while fetching the students.");
        }
    }


    function deleteRow(row) {
        row.remove();
    }

    function createRow(table) {
        // Insert blank extra row
        const blankRow = table.insertRow();

        // Add blank cells
        blankRow.insertCell();
        blankRow.insertCell().contentEditable = 'true';
        blankRow.insertCell().contentEditable = 'true';
        blankRow.insertCell().contentEditable = 'true';
        blankRow.insertCell().contentEditable = 'true';
        const universityCell = blankRow.insertCell();
        const actionCell = blankRow.insertCell();

        universityCell.textContent = lookupData.universityEntity.in23gl_universityname;
        // Create buttons for extra row
        const addUpdateBtn = createButton('Create');
        addUpdateBtn.onclick = () => {
            createEntity(blankRow, universityRef);
        }
        const addDeleteBtn = createButton('Delete');
        addDeleteBtn.onclick = () => {
            deleteEntity(blankRow);
        }

        // Append to extra row
        actionCell.appendChild(addUpdateBtn);
        actionCell.appendChild(addDeleteBtn);
    }

    function openErrorDialog(errorMessage) {
        window.parent.Xrm.Navigation.openErrorDialog({ message: errorMessage }).then(
            function (success) {
                console.log("Error dialog closed");
            },
            function (error) {
                console.log("An error occurred while opening the error dialog: ", error.message);
            }
        );
    }

    function openAlertDialog(alertStrings) {
        const alertOptions = { height: 120, width: 260 };
        window.parent.Xrm.Navigation.openAlertDialog(alertStrings, alertOptions).then(
            function (success) {
                console.log("Updated Successfully!");
            },
            function (error) {
                console.log("ErrorMessage: ", error.message);
            }
        )
    }


    function objectsAreEqual(obj1, obj2) {
        // Check if both objects are null or undefined
        if (obj1 == null || obj2 == null) return obj1 === obj2;

        // Get the keys of both objects
        const keys1 = Object.keys(obj1);
        const keys2 = Object.keys(obj2);

        // Check if the number of properties is the same
        if (keys1.length !== keys2.length) return false;

        // Check if the values of the properties are the same
        for (let key of keys1) {
            if (typeof obj1[key] === 'object' && typeof obj2[key] === 'object') {
                // If the property is an object, recursively compare
                if (!objectsAreEqual(obj1[key], obj2[key])) return false;
            } else if (obj1[key] !== obj2[key]) {
                // If the property is not an object, use strict equality
                return false;
            }
        }

        return true;
    }

</script>

</body>
</html>
