<!DOCTYPE html>
<html lang="en">
<head>
    <title>Students</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
          crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/WebResources/in23gl_js_wr_student" type="text/javascript"></script>
    <link href="/WebResources/in23gl_css_wr_student" rel="stylesheet" type="text/css" />
</head>
<body>
<div class="container mt-4">
    <div class="mb-3">
    </div>
    <div class="table-responsive">
        <table id="studentsTable" class="table table-striped text-center">
            <thead>
            <tr>
                <th>Student ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>DOB</th>
                <th>Email</th>
                <th>University</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <!-- Rows will be added here from the JS file -->
            </tbody>
        </table>
    </div>
</div>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            <!-- The `window.fetchStudents` function is responsible for populating the table with student data. -->
            window.fetchStudents = async function(students) {
                try {
                    console.log("studentsHTML: ", students);
                    console.log('lookupDataHTML: ', lookupData)
                    // Process the result
                    const table = document.getElementById('studentsTable');
                    // Loop through the data and create a table row for each student
                    students.entities.forEach( student => {
                        const row = table.insertRow();
                        //access the data from the entities and assign to corresponding cell within the table
                        const idCell = row.insertCell()
                        const firstNameCell = row.insertCell()
                        const lastNameCell = row.insertCell()
                        const dobCell = row.insertCell()
                        const emailCell = row.insertCell()
                        const universityCell = row.insertCell()
                        const actionCell = row.insertCell();

                        idCell.textContent = student.in23gl_studentid;
                        firstNameCell.textContent = student.in23gl_firstname;
                        lastNameCell.textContent = student.in23gl_lastname;

                        const date = new Date(student.in23gl_dob);
                        dobCell.textContent = date.toLocaleDateString('en-us', {timeZone: 'UTC'});
                        emailCell.textContent = student.in23gl_email;
                        universityCell.textContent = lookupData.universityEntity.in23gl_universityname;

                        firstNameCell.contentEditable = 'true';
                        lastNameCell.contentEditable = 'true';
                        dobCell.contentEditable = 'true';
                        emailCell.contentEditable = 'true';

                        const updateButton = newButton('Update');
                        updateButton.onclick = () => updateEntity(row);

                        const deleteButton = newButton('Delete');
                        deleteButton.onclick = () => deleteEntity(row);

                        actionCell.appendChild(updateButton);
                        actionCell.appendChild(deleteButton);
                    });
                    createRow(table);

                } catch (error) {
                    console.error(error);
                    openErrorDialog({
                        message: error.message,
                        errorCode: error.errorCode,
                        details: error.message
                    });
                }
            }

            // Create button
            // Create button
            function newButton(textContent) {
                const button = document.createElement('button');
                button.textContent = textContent;
                button.className = 'btn btn-sm btn-primary btn-rounded m-2';
                return button;
            }


            async function createEntity(row) {

                try {
                    // Get updated values
                    const firstNameCell = row.cells[1];
                    const lastNameCell = row.cells[2];
                    const dobCell =  row.cells[3];
                    const emailCell = row.cells[4];

                    const updatedFields = {
                        "in23gl_firstname": firstNameCell.textContent,
                        "in23gl_lastname": lastNameCell.textContent,
                        "in23gl_dob": new Date(dobCell.textContent).toLocaleDateString('en-us', {timeZone: 'UTC'}),
                        "in23gl_email": emailCell.textContent,
                        // Associate to the university lookup value use the navigation property see pic
                        "in23gl_University@odata.bind": "/in23gl_universities(" + lookupData.universityEntity.in23gl_universityid +")"
                    };

                    const result = await xrm.WebApi.createRecord("in23gl_student", updatedFields)
                    row.cells[0].textContent = result.id;

                    const actionCell = row.cells[6];
                    const updateButton = $(actionCell).find("button:contains('Create')");
                    updateButton[0].textContent = "Update";
                    updateButton[0].onclick = () => updateEntity(row);
                    const deleteButton = $(actionCell).find("button:contains('Delete')")
                    deleteButton[0].style.display = 'inline-block';

                    openAlertDialog({ confirmButtonLabel: "Ok",
                        text: "Created Student Successfully with ID " + result.id,
                        title: "Create Entity"
                    });

                    createRow($('#studentsTable')[0])

                } catch (error) {
                    console.error(error);
                    openErrorDialog({
                        message: error.message,
                        errorCode: error.errorCode,
                        details: error.message
                    });
                }
            }

            async function updateEntity(row) {
                try {
                    // Get updated values
                    const firstNameCell = row.cells[1];
                    const lastNameCell = row.cells[2];
                    const dobCell =  row.cells[3];
                    const emailCell = row.cells[4];
                    const updatedFields = {
                        in23gl_firstname: firstNameCell.textContent,
                        in23gl_lastname: lastNameCell.textContent,
                        in23gl_dob: new Date(dobCell.textContent),
                        in23gl_email: emailCell.textContent
                    };
                    console.log('updatedFields', updatedFields)
                    // Compare current and updated values
                    const studentId = row.cells[0].textContent;
                    await xrm.WebApi.updateRecord("in23gl_student", studentId, updatedFields);
                    const alertStrings = { confirmButtonLabel: "Ok", text: "Entity updated successfully!", title: "Update Entity" };
                    openAlertDialog(alertStrings);
                } catch (error) {
                    console.error(error.message);
                    openErrorDialog({
                        message: error.message,
                        errorCode: error.errorCode,
                        details: error.message
                    })
                }
            }

            async function deleteEntity(row) {
                try {
                    const studentId = row.cells[0].textContent;
                    if (studentId !== "") {
                        var confirmStrings = { text:"Are you sure you want to delete this entity? This is irreversible. If you want to delete press Ok.", title:"Delete Entity" };
                        var confirmOptions = { height: 200, width: 450 };
                        window.parent.Xrm.Navigation.openConfirmDialog(confirmStrings, confirmOptions).then(
                            function (success) {
                                if (success.confirmed) {
                                    xrm.WebApi.deleteRecord("in23gl_student", studentId);
                                    deleteRow(row);
                                    console.log("Deleted");
                                }
                                else
                                    console.error("Dialog closed using Cancel button or X.");
                            });

                    } else {

                    }
                } catch (error) {
                    const errorOptions = {
                        message: error.message,
                        errorCode: error.errorCode,
                        details: error.message
                    }
                    openErrorDialog({
                        message: error.message,
                        errorCode: error.errorCode,
                        details: error.message
                    });
                }
            }


            function deleteRow(row) {
                row.remove();
            }

            function createRow(table) {
                // Insert blank extra row
                const blankRow = table.insertRow();

                // Add blank cells
                blankRow.insertCell();
                blankRow.insertCell().contentEditable = 'true';
                blankRow.insertCell().contentEditable = 'true';
                blankRow.insertCell().contentEditable = 'true';
                blankRow.insertCell().contentEditable = 'true';
                const universityCell = blankRow.insertCell();
                const actionCell = blankRow.insertCell();

                universityCell.textContent = lookupData.universityEntity.in23gl_universityname;
                // Create buttons for extra row
                const createButton = newButton('Create');
                createButton.onclick = () => {
                    openCreateForm();  //createEntity(blankRow);
                }
                const deleteButton = newButton('Delete');
                deleteButton.style.display = 'none';
                deleteButton.onclick = () => {
                    deleteEntity(blankRow);
                }

                // Append to extra row
                actionCell.appendChild(createButton);
                actionCell.appendChild(deleteButton);
            }

            function openErrorDialog(errorOptions) {
                window.parent.Xrm.Navigation.openErrorDialog(errorOptions).then(
                    success => console.log("Error dialog closed"),
                    error => console.log("An error occurred while opening the error dialog: ", error.message)
                );
            }

            function openAlertDialog(alertStrings) {
                const alertOptions = { height: 120, width: 260 };
                window.parent.Xrm.Navigation.openAlertDialog(alertStrings, alertOptions).then(
                    success => console.log("Updated Successfully!"),
                    error => console.log("ErrorMessage: ", error.message)
                );
            }
            // fix: this is not registering the event listener when double clicking a row
            $("#studentsTable tr").dblclick(function() {
                 let entityFormOptions = {};
                let guid = $(this).find('td').eq(0).text();
                entityFormOptions["entityName"] = "in23gl_student";
                entityFormOptions["entityId"] = guid;
                try {
                    window.parent.Xrm.Navigation.openForm(entityFormOptions);
                } catch (error) {
                    openErrorDialog({
                        message: error.message,
                        errorCode: error.errorCode,
                        details: error.message
                    });
                }
            });

            function openCreateForm() {
                try {
                    window.parent.Xrm.Navigation.openForm({entityName: "in23gl_student"});
                } catch (error) {
                    openErrorDialog({
                        message: error.message,
                        errorCode: error.errorCode,
                        details: error.message
                    });
                }
            }

        </script>

    </body>
</html>
